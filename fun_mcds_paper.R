
### Rocio Prieto Gonzalez
### simulation to check the bias in DS using model selection (with no movement)

### 30/07/15


#################################################
#################   functions   #################
################################################# 


library(numDeriv)
library(EQL)
library(plyr)
library("RColorBrewer")
library(mgcv)

# detection function 
# hn (param 14)
detfunc_hn <- function(x, sigma) {return(exp(-((x/sigma)^2)/2))}
# hazard-rate, (param 10 and 2)
detfunc_hr <- function(x, sigma,b) {return( 1-exp(-(x/sigma)^(-b)) )}
# hazard-rate, (param 10 and 2)
detfunc_EPS <- function(x, lambda,p) {return( exp(-(x/lambda)^(p)) )}

detfunc <- function(md, x, par) {
  # par: vector con parametros!
  switch (md,
          'hn' ={ out <- detfunc_hn(x, par[1]) },
          'hr' ={ out <- detfunc_hr(x, par[1], par[2]) },
          'EPS'={ out <- detfunc_EPS(x, par[1], par[2]) },) 
  return(out)
}


integral <- function(w, par, md){
  # par: es un vetor de pararmetros en nuestro caso
  #      md: hn     par: (sigma)
  #          hr          (sigma, b)
  #          EPS         (lambda, p)  
  switch (md,
          'hn' ={ out <-  integrate(detfunc_hn, 0.000001,w, par[1], rel.tol=0.000001)},
          'hr' ={ out <-  integrate(detfunc_hr, 0.000001,w, par[1], par[2], rel.tol=0.000001)},
          'EPS'={ out <-  integrate(detfunc_EPS, 0.000001,w, par[1], par[2], rel.tol=0.000001)},) 
  return(out$value)
}


integral.r <- function(w, par, md){
  # par: es un vetor de pararmetros en nuestro caso
  #      md: hn     par: (sigma)
  #          hr          (sigma, b)
  #          EPS         (lambda, p)  
  switch (md,
          'hn' ={ out <- integrate(function(x, sigma){x*detfunc_hn(x, sigma)},
                                   0.000001, w, par[1], rel.tol=0.00001) },
          'hr' ={ out <- integrate(function(x, sigma,b){x*detfunc_hr(x, sigma,b)},
                                   0.000001, w, par[1], par[2], rel.tol=0.00001)},
          'EPS'={ out <- integrate(function(x, lambda,p){x*detfunc_EPS(x, lambda,p)},
                                   0.000001, w, par[1], par[2], rel.tol=0.00001) },) 
  return(out$value)
}


averageProb <- function(par, w, md, DS){  ## Phat_fun
  # par: es un vetor de pararmetros en nuestro caso
  #      md: hn     par: (sigma)
  #          hr          (sigma, b)
  #          EPS         (lambda, p)  
  switch (DS,
          'LT' ={ int <- integral(w, par, md)  
                  P <- int/w },
          'PT' ={ int <- integral.r(w, par, md)
                  P <- 2*int/(w^2) },)
  return(P) 
}


input_param <- function(md, DS, w=30){
  switch (md,
          'hr' ={ param= c(6.9, 1.5,
                           8.5, 1.7,
                           10, 2, 
                           11.5, 2.3,
                           13, 2.6,
                           14.5, 3,
                           16, 3.4,
                           17.4, 3.9)
          },
          'EPS' ={ param= c( 13.8,1.12 ,
                             16, 1.35,
                             18.1,1.65, 
                             19.7, 2,
                             21.2, 2.5,
                             22.5, 3.2,
                             23.8, 3.9,
                             25, 4.9)
          },) 
  det1 = averageProb(c(param[1],param[2]), w, md, DS)  
  det2 = averageProb(c(param[3],param[4]), w, md, DS)
  det3 = averageProb(c(param[5],param[6]), w, md, DS)
  det4 = averageProb(c(param[7],param[8]), w, md, DS)
  det5 = averageProb(c(param[9],param[10]), w, md, DS)
  det6 = averageProb(c(param[11],param[12]), w, md, DS)
  det7 = averageProb(c(param[13],param[14]), w, md, DS)
  det8 = averageProb(c(param[15],param[16]), w, md, DS)
  return(list (param =param, det= c(det1, det2, det3, det4, det5, det6, det7, det8)) )
}


# Check the distances to the PT
dis.center <- function(x1,y1){ return(sqrt( (x1)^2 + (y1)^2 ) ) }


generate.data <- function(no, md, w, DS){
  # INPUT
  #     Pasamos el modelo md (hr or EPS)  y demos sus parametros con distintas shapes
  #     Calculamos las detecciones producidas por todos los modelos
  #     DS puede ser "LT" o "PT"
  #     Y VEMOS Q SEAN MAS DE no DETECIONES
  # OUTPUT
  #     devolvemos las no distancias de cada det.fun 
  #     a matriz no x (8 md) 8 parametrizaciones 
  
  # Def param: los parámetros del modelo md (hr or EPS) con distintas shapes
  switch (md,
          'hr' ={ param <- c(6.9, 1.5, 8.5, 1.7,10, 2, 11.5, 2.3,13, 2.6,14.5, 3,16, 3.4,17.4, 3.9)},
          'EPS' ={ param <- c( 13.8,1.12 ,16, 1.35,18.1,1.65, 19.7, 2,21.2, 2.5,22.5, 3.2, 23.8, 3.9,25, 4.9)},) 
  
  # generamos las observaciones
  posi.x <- runif(no*10,-w,w)
  posi.y <- runif(no*10,-w,w)
  
  # distance of the detected animals
  if (DS=="PT"){
    dist <- dis.center(posi.x, posi.y)
    dist <- dist[dist<=w]
  }else{ # DS =="LT"
    dist <- abs(posi.y)
  }
  
  distances <- matrix(data=NA, nrow=no, ncol=8)
  for (j in 1:8){
    # vemos si son detectadas o no las dist
    if (md == "hr"){
      prob <- detfunc_hr(dist, param[2*j-1], param[2*j])
    } else{ # md == EPS"
      prob <- detfunc_EPS(dist, param[2*j-1], param[2*j])
    }
    dett <- rbinom(length(dist), 1, prob) 
    distt  <- ifelse( dett==1, dist, NA)
    distan <- distt[!is.na(distt)]
    det <- length(distan)  
    
    while(det<no){ # no tenemos suficientes detecciones para the sample size
      # generamos mas posiciones para aumnetar el num de detecctions
      posi2.x <- runif(no*4,-w,w)
      posi2.y <- runif(no*4,-w,w)
      if (DS=="PT"){
        dist2 <- dis.center(posi2.x, posi2.y)
        dist2 <- dist2[dist2<=w]
      }else{ # DS=="LT"
        dist2 <- abs(posi2.y)
      }    
      
      if (md == "hr"){
        prob2 <- detfunc_hr(dist2, param[2*j-1], param[2*j])
      } else{ # md == EPS"
        prob2 <- detfunc_EPS(dist2, param[2*j-1], param[2*j])
      }        
      dett2 <- rbinom(length(dist2), 1, prob2) 
      # nuevas detecciones
      distt2  <- ifelse( dett2 ==1, dist2, NA)
      distan2 <- distt2[which(distt2>=0)]
      
      # Anadimos las nuevas detecciones
      distan <- c(distan, distan2)
      
      # comprobamos q tengamos suficientes...
      det <- length(distan)
    }
    
    # ya tenemos suficientes deteciones
    distances[,j] <- format(round(distan[1:no], 8), nsmall=8)
    # format.default(distan[1:no], digits = 8) 
  }
  return(distances)
}


neg.log.f <- function(par, r, w, md, DS){
  # INPUT
  #   par: parameters of the model
  #   r: distances, w: truncature distance, md: "hr" "EPS", DS: "LT" "PT"
  # OUTPUT
  #   Return the neg log likelihood 
  
  # I believe this was the cause of mmany problems in optim using the method "BFGS"
  # t <- exp(par)  
  t <- par
  switch (DS,
          'LT' ={ integral <- integral(w, t, md)  
                  switch (md,
                          'hn' ={ log.like <- sum( log(detfunc_hn(r, t[1])) -log(integral))},
                          'hr' ={ log.like <- sum( log(detfunc_hr(r, t[1], t[2])) -log(integral)) },
                          'EPS'={ log.like <- sum( - (r/t[1])^t[2] -log(integral)  )},)  },
          'PT' ={  integral <- integral.r(w, t, md)
                   switch (md,
                           'hn' ={ log.like <- sum( log(r) + log(detfunc_hn(r, t[1])) -log(integral))},
                           'hr' ={ log.like <- sum( log(r) + log(detfunc_hr(r, t[1], t[2])) -log(integral)) },
                           'EPS'={ log.like <- sum( log(r) - (r/t[1])^t[2] -log(integral)) },)  },)
  return(-log.like)       
}


ll <- function(par, r, w, md, DS, summary_fun=function(x) -sum(x)){
  # par =EMV;r=distan; w=w; md=md; DS=DS; summary_fun=identity
  # INPUT
  #   par: parameters of the model
  #   r: distances, w: truncature distance, md: "hr" "EPS", DS: "LT" "PT"
  #   summary_fun: by default for optimisation we want the negative sum of the log likleihood
  #                but for derivatives we may want the pdf evaluated for each observation, so summary_fun=identity is appropriate 
  # OUTPUT
  #   Return the neg or pos log likelihood depending on neg (T or F)
  t <- par
  # t <- exp(par)
  switch (DS,
          'LT' ={ integrall <- integral(w, t, md)  
                  switch (md,
                          'hn' ={ log.like <- log(detfunc_hn(r, t[1])) -log(integrall) },
                          'hr' ={ log.like <- log(detfunc_hr(r, t[1], t[2])) -log(integrall) },
                          'EPS'={ log.like <-  - (r/t[1])^t[2] -log(integrall)  },)  },
          'PT' ={  integrall <- integral.r(w, t, md)
                   switch (md,
                           'hn' ={ log.like <- log(r) + log(detfunc_hn(r, t[1])) -log(integrall) },
                           'hr' ={ log.like <- log(r) + log(detfunc_hr(r, t[1], t[2])) -log(integrall) },
                           'EPS'={ log.like <- log(r) - (r/t[1])^t[2] -log(integrall) },)  },)
  
  log.like[is.infinite(log.like) | is.nan(log.like)] <- -1e15
  out <- summary_fun(log.like)
  return(out)       
}

#EMVmd_Phat(distan, w, initial.val, md, DS, 0.01)
#initial.val= initial.val[c(2*col-1,2*col)]

EMVmd_Phat <- function(r, w, initial.point, md, DS, cota=0.01){
  # Estimate the EMV of the det fun and the average probability of detection
  # INPUT
  #   r: vector of distances
  #   w: truncation distance
  #   initial.point to maximice the loglikelihood function
  #   md : EPS or hr
  #   DS: LT or PT
  # OUTPUT
  #   EMV de la det fun
  #   P average probability of detection
  #   P= NA if optim not converge  
  r <- as.numeric(r)
  
  # Using neg.log.f 
  # (making sure the param are positives) so we make the tranformation t=exp(par)

  # method.optim=c("BFGS", "Nelder-Mead","CG", "L-BFGS-B")
  fit <- try( optim(par=c(initial.point[1], initial.point[2]), fn=neg.log.f, 
                    r= r, w= w, md=md, DS=DS, method= "L-BFGS-B", 
                    lower=c(0.5,0.2), upper=c(40,10)), silent=T)
  #     # using ll ( no taking exp(parameters) )
  #     fit <- try( optim(par=c(initial.point[1],initial.point[2]), fn=ll, r= distan, w= w, md=md, DS=DS, 
  #                     method= "BFGS"), silent=T)
  #     EMV <- fit$par
  # comprobamos q converja
  if(unique(class(fit)=="try-error")==T){ # no converge!
    EMV <-c(NA, NA);  Phat<-NA} 
  else{ #converge pero vemos si es menor q 0.01
    EMV <- (fit$par)
    Phat <- averageProb(EMV, w, md, DS)
    # chequeamos q P no sea muy pequeno... < 0.01
    if(Phat< cota){EMV <-c(NA, NA);  Phat<-NA} 
  }
  return(c(EMV, Phat))
}


read.stats.file<-function(k, max.par) {
  # INPUT
  #     k: number of the stats txt we are reading the resutls of
  #     max.par: the max number of param we are fitting 
  #              ("all" or "2" or "3")
  # OUTPUT
  #   Purpose: extracts results statistics we need from the MCDS stat file
  #   Phat: (module 2, statistic 5), 
  #   params: of the det fun (module 2, statistic 100, ... ,100+m)
  #   AIC: (module 2, statistic 2)
  #   md: unif, hn, hr, unif+cos, hn+cos, hr+cos, unif+s.poly, hn+H.poly, hr+s.poly
  #           (module 2, statistic 13) - key function type md.number
  #           1 = unif, 2 = half-normal, 3 = neg exp, 4 = hr
  #   f0: (module 2, statistic 5)
  #            (module 2, statistic 4)
  #   no.adj.term: number of adjustment term parameters (module 2, statistic 16)
  #   adj.term.types: (module 2, statistic 14)
  #           1 = simple polynomial, 2 = Hermite polynomial, 3 = cosine
  #   CI: 95% (module 2, statistic 5)
  
  doc <- paste("stat",k,".txt", sep="")
  stats <-read.table(doc)
  names(stats) <- c("stratum", "sample", "estimator", "module", "statistic", 
                    "value", "cv", "lcl", "ucl", "df")
  Phat<-stats[stats$module==2 & stats$statistic==5 ,"value"]
  params<-stats[stats$module==2 & stats$statistic>100 ,"value"]
  AIC<-stats[stats$module==2 & stats$statistic==7 ,"value"]
  md.number<-stats[stats$module==2 & stats$statistic==13 ,"value"]
  f0<-stats[stats$module==2 & stats$statistic==4 ,"value"] 
  no.adj.term<-stats[stats$module==2 & stats$statistic==16 ,"value"]
  adj.term.type<-stats[stats$module==2 & stats$statistic==14 ,"value"]
  CI<-stats[stats$module==2 & stats$statistic==5 ,c("lcl", "ucl")]
  
  # Guardamos el modelo escogido con
  # md= unif, hn, hr, unif+cos, hn+cos, hr+cos, unif+s.poly, hn+H.poly, hr+s.poly
  # order=
  # md <- modelo(i, md.number, params)
  switch (max.par,        
          'all' ={ 
            switch (k,        
                    '1' ={ if(md.number==1){md='unif'}else {if(md.number==2){md='hn'} else {md='hr'}} },
                    '2' ={ switch (as.character(md.number),
                                   '1' ={ if(length(params)==0){md='unif'}else{md='unif+cos'} },
                                   '2' ={ if(length(params)==1){md='hn'}else{md='hn+cos'} },
                                   '4' ={ if(length(params)==2){md='hr'}else{md='hr+cos'} },) 
                    },
                    '3' ={ switch (as.character(md.number),
                                   '1' ={ if(length(params)==0){md='unif'}else{md='unif+s.poly'} },
                                   '2' ={ if(length(params)==1){md='hn'}else{md='hn+H.poly'} }, 
                                   '4' ={ if(length(params)==2){md='hr'}else{md='hr+s.poly'} }, )
                    },
                    '4' ={ md='hr' },) 
            },
          '2' ={  # k=1 it's the only case!
            if( (md.number==1) &  (adj.term.type==3) ) {md='unif+cos'}else{
              if( (md.number==1) &  (adj.term.type==1) ) {md='unif+s.poly'}else{
                if( (md.number==2) &  (adj.term.type==3) ) {md='hn+cos'}else{
                  if( (md.number==2) &  (adj.term.type==2) ) {md='hn+H.poly'}else{md='hr'}
                }
              } 
            }
            },
          '3' ={ 
            switch (k,        
                    '1' ={ 
                      if( (md.number==1) &  (adj.term.type==3) ) {md='unif+cos'}else{
                        if( (md.number==1) &  (adj.term.type==1) ) {md='unif+s.poly'}else{
                          if( (md.number==2) &  (adj.term.type==3) ) {md='hn+cos'} else{md='hn+H.poly'}
                        }
                      }
                      },
                    '2' ={ 
                      if( (md.number==4) &  (adj.term.type==3) ) {md='hr+cos'}else{md='hr+s.poly'}
                    },)  
            },)  
  return(list(md=md, AIC=AIC, Phat=Phat, params=params, f0=f0,
              adj.term.type=adj.term.type, no.adj.term=no.adj.term, CI=CI))
}



mcds.conver <- function(res){
  if(is.vector(res)) res <- res[1]
  res<-as.integer(res)
  if(is.na(res)) res<-5
  return(res)
}


create.mcds.data.file <- function(distan){
  dat <- data.frame(1,0,1,1, distan)  
  # lo gurdamos en un txt llamado "datain.txt"
  data.file.name <- "datain.txt"
  file.create(data.file.name)
  write.table(dat,data.file.name, sep="\t",na="",row.names=F,col.names=F,quote=F)
}


VarPhat <- function(EMV,distan, w,md, DS){
  # INPUT
  #   EMV: vector of parameters of the model
  #      md: hn     EMV: (sigma)
  #          hr          (sigma, b)
  #          EPS         (lambda, p)  
  #   w: truncature distance, md: "hr" "EPS", DS: "LT" "PT"
  # OUTPUT 
  #   returns the variance of the Phat
  
  ## Jacobian of Probability of detecction in the EMV
  # Jacobian returns a (# return values) x (# 1st args) matrix
  Jp <- t(jacobian(averageProb, EMV, method= "Richardson", w=w, md=md, DS=DS))
  Jp
  ## derivatives and uncertainty
  # using hessian() and jacobian() functions from numDeriv
  # extract or calculate the Hessian of the likelihood
  # a) hessian(ll, EMV, r=distan, w=w, md=md, DS=DS, summary_fun=identity)
  # b)calculate the 1st Hessian
  #  (product of 1st partial derivatives per observation)
  # Distance use the Jacobian to estimate the 1st Hessian (we do it as distnace software)
  # method reccommended in Appendix C of "Estimating Animal Abundance" by
  # Borchers, Buckland & Zucchini.
  gr <- jacobian(ll, EMV, r=distan, w=w, md=md, DS=DS, summary_fun=identity)
  # gr is a n*npars matrix
  hessian1 <- t(gr)%*%gr
  # obtain the variance-covariance matrix
  var.matrix <- try(solve(hessian1), silent=TRUE)
  ## Var of P is the Var of the likelihood proyected in the espace of Phat...
  # variance of P from model via sandwich estimator
  var_P <- as.vector(t(Jp) %*% var.matrix %*% Jp)
  return(var_P)
}


CI95 <- function(P, varP, alpha=0.05 ){
  # We assume N follows a log-normal distributions so IC: [N/C, N*C]
  # alpha is the level of confidence by default alpha=0.05 ==> 95% CI 
  #                                             alpha= 0.1 ==> 90% CI
  z.halfalpha <- qnorm(1-alpha/2)
  C <-exp(z.halfalpha* sqrt( log(1+ varP/(P^2)) ) )
  return(c(P/C, P*C))
}



run.mcds <- function(distan, DS, no, w, md, monot, max.par, initial.val) {
  # Purpose: runs the MCDS.exe engine and waits for it to finish
  #  *Note* that mcds.exe needs to be in the current directory
  # Returns:
  #  A status integer - 1=OK, 2=warnings, 3=errors, 4=file errors, 
  #    5=some other problem (e.g., program crash)
  
  # INPUT
  #   distan: a vector of distances of length no  
  #   DS: LT, PT
  #   no: number of detected objects
  #   w: truncation distance
  #   md: hr or EPS
  #   monot: opciones para la det fun -> "M" (monotonic), "NM" (non monotonic), 
  #   maxpar: par2 o 3 or all-max.5 adjustem terms 
  #           (fit md with only 2 or 3 param in total) 
  #   parametrization: is the parapetrization passed
  # OUTPUT
  #   a list with 3 things for model selection and the true model
  #   ms: the lowest AIC model, and 
  #   tm: true model (the one we are generating the data from - hr or EPS-)
  #   1) c(res.ms,res.tm), 
  #      a vector of estimates (nhat, Phat, 95%CIPhat) dim= 4x2
  #   2) c(ms,tm), 
  #      a charather vector (md, #adj.term, f0, params) 
  #      (md: unif, hn, hr, unif+cos, hn+cos, hr+cos, unif+s.poly, hn+H.poly, hr+s.poly)
  #      because of the #parm the length varies...
  #   3) c(conver.ms, conver.tm), 
  #      a vector of convergence for each model fitted. 
  #      1. OK 2. some warning... 5. No-convergence
  
  # Creamos un txt file con las distancias to run it in mcds
  create.mcds.data.file(distan)
  
  ############################ MODEL SELECTION
  # Selecionamos el fichero para hacer el analisis
  ## allpar
  #     command1       fit unif, hn, hr
  #     command2       fit unif+cos, hn+cos, hr+cos
  #     command3       fit unif+Spoly, hn+Hpoly, hr+Spoly
  #     command4       fit hr
  ## 2par
  #     command1       fit unif+cos(2), unif+Spoly(2), hn+cos(1), hn+Hpoly(1), hr
  ## 3par
  #     command1       fit unif+cos(3), unif+Spoly(3), hn+cos(2), hn+Hpoly(2)
  #     command2       fit hr+cos(1), hr+Spoly(1)
  
  switch (max.par,
          'all' ={num.files <- 3},
          '2'   ={num.files <- 1},
          '3'   ={num.files <- 2},)
  mcds <- array(dim=num.files); command <- array(dim=num.files)
  conver <- array(dim=num.files); res <- list()
  # Hacemos el analisis y guardamos los resultados en res[[i]]
  switch (as.character(w),
          "30" ={for (i in 1:num.files){command[i] <- paste("mcds 0, \"command",i,"_", DS,"_",monot, "_", max.par, "par.txt\"", sep="")} },
          "20" ={for (i in 1:num.files){command[i] <- paste("mcds 0, \"command",i,"_", DS,"_",monot, "_", max.par, "par_w20.txt\"", sep="")}},)
  for (i in 1:num.files){
    mcds[i] <- try (suppressWarnings(system(command[i], intern=TRUE, invisible=TRUE)), silent=TRUE)[1]
    if ( (unique(class(mcds[i])=="try-error")==FALSE) & (mcds[i]!="")){ res[[i]]<-read.stats.file(i, max.par) }
    conver[i] <- mcds.conver(mcds[i])
  }
  # Seleccionamos el mejor modelo:
  # como la lista tiene distintas dim dependiendo del num de parametros, pilla todos los AIC of the list
  # AIC <- c(res[[1]]$AIC, res[[2]]$AIC, res[[3]]$AIC) 
  AIC <- sapply(res, function(x){ as.numeric(x$AIC) }) 
  # min <- which.min(AIC) # nos da la posicion del md q tiene menor AIC
  # Elegimos modelo 
  if (length(AIC)==num.files){ #### verificando q converja!!!
    conver.ms <- conver[which.min(AIC)] 
    resms<- res[[which.min(AIC)]]
    # output for ms   (# resms$f0)
    ms <- c(resms$md, resms$no.adj.term, resms$params )
    res.ms <- c(nhat_ms= no/resms$Phat, Phat_ms= resms$Phat, as.numeric(resms$CI) ) 
  }else{ # Algun command did not converge
    ms <- c(NA, NA, NA, NA)
    res.ms <- c(nhat_ms= NA, Phat_ms= NA, NA,NA ) 
    conver.ms <- 5
  }
  
  
  ############################ TRUE MODEL
  # initial.point: to maximaze the loglikelihood function 
  #               (the param of the det fun we are generating the data from)
  switch (md,
          'hr' ={ # no pasamos initial.point <- c(12,2.5) ya q queremos q sea
                  # estimado de igual manera, asi q usamos Distance Software 
                  switch (as.character(w),
                    "30" ={command4 <-paste("mcds 0, \"command4_", DS,"_",monot, "_allpar.txt\"", sep="") },
                    "20" ={command4 <- paste("mcds 0, \"command4_", DS,"_",monot, "_", max.par, "par_w20.txt\"", sep="")},)
                  mcds4<- suppressWarnings(system(command4, intern=TRUE, invisible=TRUE))
                  res4<-read.stats.file(4,"all")
                  tm <-c(res4$md, res4$no.adj.term, res4$params)
                  res.tm <- c(nhat_tm= no/res4$Phat, Phat_tm= res4$Phat, as.numeric(res4$CI)) 
                  conver.tm <- mcds.conver(mcds4)
                  },
          'EPS' ={ # initial.point <- c(19.5, 2.5) 
                   out <- EMVmd_Phat(distan, w, initial.val, md, DS, 0.01) 
                   EMV <- out[c(1,2)]
                   Phat <- out[3]
                   if (is.na(Phat)){
                     res.tm <- c(nhat_tm= NA, Phat_tm= NA, NA, NA)
                     tm <-c(md, 0, NA, NA)
                     conver.tm <- NA 
                   }else{CI.tm <- try(CI95(Phat, VarPhat(EMV, as.numeric(distan), w, md, DS) ), silent=TRUE)
                         if (inherits(CI.tm, "try-error")){ # Hay un error 
                           # "Error in t(Jp) %*% var.matrix : \n  requires numeric/complex matrix/vector arguments\n"
                           CI.tm <- c(NA, NA)}
                         res.tm <- c(nhat_tm= no/Phat, Phat_tm= Phat, CI.tm)
                         tm <-c(md, 0, EMV)
                         conver.tm <- 1  
                        }  
                   },)
  return(list (c(res.ms,res.tm), ms, tm, c(conver.ms, conver.tm) )) 
}



try.run.mcds <- function(distan, DS, no, w, md, monot, max.par, initial.val){
  # INPUT
  #     distan: vector de distancias de lenght no
  #     DS puede ser "LT" o "PT"
  #     no: num de detecciones, w: truncation distance
  #     md (hr or EPS) 
  #     run.mcds input!
  # OUTPUT
  #     devolvemos run.mcds
  return(try (run.mcds(distan, DS, no, w, md, monot, max.par, initial.val), silent=TRUE))
}
  

check.error <- function (res.i){
  # res.i is the results from the model i =1, ..., 8 (just one of the 8 forms!)
  # devuelve FALSE si no hay error and TRUE is there is
  a <-  inherits(res.i, "try-error")
  b <- is.list(res.i)
  if((a== TRUE) | (b== FALSE)){
    out <- TRUE  # there is an error in the data organization
  } else { # there is no problem with the output
    # we check convergence in Distance software and optim!
    cov <- res.i[[4]] # vector de convergencia
    # quitamos los "NA" de cuando optim did not converge
    cov[which(is.na(cov))] <- 0
    if (any(cov>2)){out <- TRUE}   # there is an error of convergence in Distance software
    else{out <- FALSE} }   # there is NO error
  return(out)
}



biasModSel<- function(i, DS, no, w, md, monot, max.par, seeds){
  # PARAMETROS DE ENTRADA
  #   no: SAMPLE SIZE!!! number of detections
  #   md: "hr" or "EPS"
  #   param: to choose the detection function to generate the data from
  #          parámetros del modelo defining distintas shapes es un vector de long 2n, 
  #          where n is the number of diff shapes (n=8)
  #   w : distance of truncature
  #   DS : "LT" or "PT"
  #   tot.iter : # of iterations we are running (so % of times the model did not converge)
  # PARAMETROS DE SALIDA
  # Devolvemos la estimacion dada por model selection y el true model
  set.seed(seeds[i])
  continue = TRUE
  tot.iter<- c()
  results<- list()
  switch (md,
          'hr' ={ initial.val <- c(6.9, 1.5, 8.5, 1.7,10, 2, 11.5, 2.3,13, 2.6,14.5, 3,16, 3.4,17.4, 3.9)},
          'EPS' ={ initial.val <- c( 13.8,1.12 ,16, 1.35,18.1,1.65, 19.7, 2,21.2, 2.5,22.5, 3.2, 23.8, 3.9,25, 4.9)},) 
  while(continue){
    print(i)
    tot.iter<- c(tot.iter, i)
    # Generate the data of the 8 diferent parametrization
    distan <- generate.data(no, md, w, DS)
    for (col in 1:8){results[[col]] <- try.run.mcds(distan[,col], DS, no, w, md, monot, max.par, initial.val[c(2*col-1,2*col)])}
    # results <- apply(distan, 2, try.run.mcds, DS, no, w, md, monot, max.par)
    if ( all(lapply(results, check.error)== FALSE) ) {continue = FALSE} 
    # no ha habido ningun error en DS/fortran , asi q salimos del while
    # sino, regeneramos mas datos
  }
  names(results) <- paste('res_',md, 1:8, sep='')
  return(RES=list(results=results, tot.iter=tot.iter))
}




#                                          ###############
############################################## RESULTS ###
#                                          ###############



guardar.datos <-function(RES, no, DS, md, monot, max.par,out.folder){
  res <- lapply(RES, function(list){return(list$results)})
  total.iter <- do.call(c, lapply(RES, function(list){return(list$tot.iter)}))
  save(total.iter, file=file.path(out.folder, "iter"))
  for(j in 1: 8){
    # estimate 
    AAP <- lapply(res, function(x){x[[j]][[1]]})
    AP <- do.call(rbind, AAP)
    file.name <- paste("AP",j, sep='')
    save(AP, file = file.path(out.folder, file.name))
    
    # model selection (ms) model
    M <- lapply(res, function(x){x[[j]][[2]]})
    ms <- t( sapply(M,'[',seq(max(sapply(M,length)))) )
    file.name <- paste("ms",j, sep='')
    save(ms, file=file.path(out.folder, file.name))
    
    # true model (tm) model
    MM <- lapply(res, function(x){x[[j]][[3]]})
    tm <- t( sapply(MM,'[',seq(max(sapply(MM,length)))) )
    file.name <- paste("tm",j, sep='')
    save(tm, file=file.path(out.folder, file.name))
    
    # md which did NOT converge
    CConv <- lapply(res, function(x){x[[j]][[4]]})
    Conv <- do.call(rbind, CConv)
    file.name <- paste("Conv",j, sep='')
    save(Conv, file=file.path(out.folder, file.name))
  }
}


AP_perc <- function(AP, no, det){
  pop.size <- no/det
  res <- (AP-c(pop.size, det, pop.size, det))*100/ c(pop.size,det,pop.size,det)
  return(round(res,2))
}

# Crear una function table q nos devuelva una tabla completa!!!
all.table <- function(M, order){
  # INPUT
  # M una matriz con dos columnas cada columna es un vector 
  # el 1ro con md sel con el md selecionado, y el 2do con el true model
  # devuelve un vector con el # de veces q se ha seleccionado cada modelo
  # hn, hr, hr+cos, unif, unif+cos
  # head(M[,1])
  models <- c(length(which(M[,1]=="unif")),length(which(M[,1]=="unif+cos")), length(which(M[,1]=="unif+s.poly")),
              length(which(M[,1]=="hn")), length(which(M[,1]=="hn+cos")), length(which(M[,1]=="hn+H.poly")),
              length(which(M[,1]=="hr")), length(which(M[,1]=="hr+cos")), length(which(M[,1]=="hr+s.poly")) )
  names (models) <- c('unif', 'unif+cos', "unif+s.poly",'hn', 'hn+cos', "hn+H.poly", 'hr', "hr+cos","hr+s.poly")
  out<- models
  if(order){
    # especificamos el orden 
    order.models <- c(length(which( M[,1]=="unif")),
                      length(which( (M[,1]=="unif+cos") & (M[,2]=="1") )),
                      length(which( (M[,1]=="unif+cos") & (M[,2]=="2") )),
                      length(which( (M[,1]=="unif+cos") & (M[,2]=="3") )),
                      length(which( (M[,1]=="unif+cos") & (M[,2]=="4") )),
                      length(which( (M[,1]=="unif+cos") & (M[,2]=="5") )),
                      length(which( (M[,1]=="unif+s.poly") & (M[,2]=="1") )),
                      length(which( (M[,1]=="unif+s.poly") & (M[,2]=="2") )),
                      length(which( (M[,1]=="unif+s.poly") & (M[,2]=="3") )),
                      length(which( (M[,1]=="unif+s.poly") & (M[,2]=="4") )),
                      length(which( (M[,1]=="unif+s.poly") & (M[,2]=="5") )),
                      length(which( M[,1]=="hn")), 
                      length(which( (M[,1]=="hn+cos") & (M[,2]=="1") )),
                      length(which( (M[,1]=="hn+cos") & (M[,2]=="2") )), 
                      length(which( (M[,1]=="hn+cos") & (M[,2]=="3") )), 
                      length(which( (M[,1]=="hn+cos") & (M[,2]=="4") )), 
                      length(which( (M[,1]=="hn+H.poly") & (M[,2]=="1") )),
                      length(which( (M[,1]=="hn+H.poly") & (M[,2]=="2") )), 
                      length(which( (M[,1]=="hn+H.poly") & (M[,2]=="3") )), 
                      length(which( (M[,1]=="hn+H.poly") & (M[,2]=="4") )), 
                      length(which(M[,1]=="hr")), 
                      length(which( (M[,1]=="hr+cos") & (M[,2]=="1") )),
                      length(which( (M[,1]=="hr+cos") & (M[,2]=="2") )), 
                      length(which( (M[,1]=="hr+cos") & (M[,2]=="3") )), 
                      length(which( (M[,1]=="hr+s.poly") & (M[,2]=="1") )), 
                      length(which( (M[,1]=="hr+s.poly") & (M[,2]=="2") )), 
                      length(which( (M[,1]=="hr+s.poly") & (M[,2]=="3") )) )                
    names (order.models) <- c('unif', 'unif+cos(1)','unif+cos(2)','unif+cos(3)', 'unif+cos(4)','unif+cos(5)',
                              "unif+s.poly(1)","unif+s.poly(2)","unif+s.poly(3)","unif+s.poly(4)","unif+s.poly(5)",
                              'hn', 'hn+cos(1)','hn+cos(2)','hn+cos(3)','hn+cos(4)',
                              "hn+H.poly(1)","hn+H.poly(2)","hn+H.poly(3)","hn+H.poly(4)",
                              'hr', "hr+cos(1)","hr+cos(2)","hr+cos(3)",
                              "hr+s.poly(1)","hr+s.poly(2)","hr+s.poly(3)" )
    out <- order.models
  }
  return(out)
} 

between <- function(x, a, b){
  # Devuelve los valores de x tq a <= x < b
  xx <- which(a<=x)
  posi <- which(x[xx]<b)
  index <- xx[posi]
  return(index)
}

no.na.mean <- function(v){return( mean(na.omit(v)) )}

no.na.sd<- function(v){return( sd(na.omit(v)) )}

no.na.median <- function(v){return( median(na.omit(v)) )}

perc <- function(AP, no, det){
  true <- c(no/det, det, no/det, det)
  return ( (AP-true) * (100/true) )
}

in_inter <- function(inter, true){
  # Devuelve 1 if true is inside the interval and 0 ifnot
  if(all(is.na(inter))){dentro <-0}else{ # es un vector sin NA's
    if( (inter[1]< true) & (true< inter[2]) ){ dentro <-1 }else{dentro <-0} }
  return(dentro)
}


CI_EPS <- function(AP){
  AP <- na.omit(AP)
  var.P_ms <- var(AP[,2])
  var.P_tm <- var(AP[,4])
  C_ms <- exp( 1.96* sqrt(log(1+ (var.P_ms/ AP[,2]) )) )
  C_tm <- exp( 1.96* sqrt(log(1+ (var.P_tm/ AP[,4]) )) )
  CI <- cbind( AP[,2]/C_ms, AP[,2]*C_ms, AP[,4]/C_tm, AP[,4]*C_tm  )
  colnames(CI) <-c("CI_ms","CI_ms", "CI_tm", "CI_tm")
  return (CI)
}

change.dir <- function(md, DS, monot,max.par, no, n.sim){
  # cambia the working directory 
  # partiendo de dropbox (path) dependiendo del md(hr o EPS)e                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            , DS(Lt o PT) y no (sample size)
  folder.results <- paste(get.dropbox.folder(ord),"\\Bias-modsel\\R\\bias\\mcds\\results\\",
                          n.sim, "iter\\",md,"\\",DS, "\\",monot, "_",max.par, "par\\N", no,   sep="")
  return(folder.results)
}

sum.results <- function(no, md, order.series.exp, n.sim, DS, monot, max.par){
  # INPUT
  #     no: sample size, # of detections
  #     detectability of the det fun which generate the data
  #     md: "hr" or "EPS"
  #     order.series.exp: logical value, TRUE or FALSE.
  #         if "T", the order of the series expantion (adjustment term) is given too
  #         if "F", not order just (unif, hn, hr, unif+cos, hn+cos, hr+cos, unif+s.poly, hn+H.poly, hr+s.poly)
  #     n.sim: # repetitions of the simulation
  #     DS: "LT" or "PT"
  #     monot: "M" or "NM"
  #     max.par: max. # of para to fitt the det fun ("all", "2" or "3")
  # OUTPUT
  # devuelve el porcentaje de bias producido por la media, la mediana
  # y tb el % mod escogidos entre los ajustados con o sin el order of the series expantion.
  
  # reservamos espacio
  Conv.prob <- matrix (0, nrow=8, ncol=3)
  AP_mean <- matrix (0, nrow=8, ncol=4)
  AP_median <- matrix (0, nrow=8, ncol=4)
  AP_sd <- matrix (0, nrow=8, ncol=4)
  AP_RMSE <- matrix (0, nrow=8, ncol=4)
  perc_AP_mean <- matrix (0, nrow=8, ncol=4)
  perc_AP_median <- matrix (0, nrow=8, ncol=4)
  perc_AP_RMSE <- matrix (0, nrow=8, ncol=4)
  perc_CI_cov <- matrix (0, nrow=8, ncol=2)
  AP_MCE <- matrix (0, nrow=8, ncol=4)
  perc_AP_MCE <- matrix (0, nrow=8, ncol=4)
  if (order.series.exp){
    Md <- matrix (0, nrow=27, ncol=8)
  }else{ Md <- matrix (0, nrow=9, ncol=8) }
  tot.NoConv <- vector(length=8)
  
  # Input parameters given a md (hr, EPS) a w, and a DS scenario (LT, PT)
  ## param: of the det function we generate the data from 
  ## and det: average probability of detection for each det fun.
  det <- (input_param(md, DS, w))$det
  cota <- 0.01
  # det <- input$det; param <- input$param 
  # We change the directory where we have saved the data
  default.wd <-getwd()
  setwd(change.dir(md, DS, monot,max.par, no, n.sim))
  # getwd()  
  for (j in 1:8){
    AP.name <- paste("AP",j, sep='')
    ms.name <- paste("ms",j, sep='')
    tm.name <- paste("tm",j, sep='')
    Conv.name <- paste("Conv",j, sep='')
    load(AP.name); load (ms.name); load (tm.name); load(Conv.name)
    
    # Chequeamos q Phat sea > 0.01=cota
    # Si Phat <0.01 => guardamos un NA como MLE y mod
    ind.DS <- which(AP[,2]<cota); ind.tm <- which(AP[,6]<cota)
    if(length(ind.DS)>0){AP[ind.DS,c(5,6,7,8)]=NA}
    if(length(ind.tm)>0){AP[ind.tm,c(5,6,7,8)]=NA}
  
    D <- is.na(AP[,1]); DS.prob <- c(length(which(D)), which(D))
    opt<- is.na(AP[,5]); opt.prob <-c(length(which(opt)), which(opt))
    CI.p <- is.na(AP[,7]); CI.prob <-c(length(which(CI.p)), which(CI.p))
    Conv.prob[j,] <- c(DS.prob[1],opt.prob[1],CI.prob[1])*100/n.sim
    
    # Quitamos los na xq no hay convergencia
    AP_mean[j,] <- apply( AP[,c(1,2,5,6)], 2, no.na.mean ) 
    AP_median[j,] <- apply( AP[,c(1,2,5,6)], 2, no.na.median )
    
    perc_AP_mean[j,] <- AP_perc(AP_mean[j,], no, det[j])
    perc_AP_median[j,] <- AP_perc(AP_median[j,], no, det[j])
    
    # SD and RMSE
    AP_sd[j,] <- apply( AP[,c(1,2,5,6)], 2, no.na.sd )
    ## var=sd^2
    AP_RMSE[j,] <- sqrt((AP_sd[j,])^2 + ( AP_mean[j,] - (c(no/det[j], det[j], no/det[j], det[j])) )^2)
    perc_AP_RMSE[j,] <- (AP_RMSE[j,])*100/c(no/det[j], det[j], no/det[j], det[j])
      
    # MCE of the percetnage of error 
    AP_MCE[j,] <- (apply(AP[,c(1,2,5,6)], 2, no.na.sd)/sqrt(c(n.sim, n.sim, n.sim-length(which(opt)), n.sim-length(which(opt)))))  # eq7 de articulo eli Koeheler
    # maybe need a no.na.sd function...
    perc_AP_MCE[j,] <- AP_MCE[j,]*100/ c(no/det[j], det[j], no/det[j], det[j])
    
    # IC coverage 
    # Calculamos cuantos CI recogen a true P 
    inside.ms <- sum(apply(AP[,c(3,4)], 1, in_inter, det[j])) *100/(n.sim-length(which(D)))
    inside.tm <- sum(apply(AP[,c(7,8)], 1, in_inter, det[j])) *100/(n.sim-length(which(CI.p)))
    perc_CI_cov[j,] <- c( inside.ms, inside.tm)
    
    # Model selection
    Md[,j] <- all.table(ms, order.series.exp)
    # tot.NoConv[j] <- sum (Conv)
  }
  load("iter")
  Conv.prob[,1] <-(length(total.iter)-n.sim)*100/n.sim
  
  colnames(AP_mean) <-c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm"); colnames(AP_median) <-c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm")
  colnames(AP_sd) <-c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm"); colnames(AP_RMSE) <-c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm")
  colnames(perc_AP_RMSE) <-c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm"); rownames(perc_AP_RMSE) <- paste(md, 1:8, sep='')
  rownames(AP_mean)=rownames(Conv.prob) <- paste(md, 1:8, sep='');  rownames(AP_median) <- paste(md, 1:8, sep='')
  rownames(AP_sd) <- paste(md, 1:8, sep='');  rownames(AP_RMSE) <- paste(md, 1:8, sep=''); colnames(Conv.prob) <-c("Distance","optim","true.CI")
  colnames(perc_AP_mean) <-c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm"); colnames(perc_AP_median) <-c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm")
  rownames(perc_AP_mean) <- paste(md, 1:8, sep='');  rownames(perc_AP_median) <- paste(md, 1:8, sep='')
  rownames(perc_AP_MCE) <- paste(md, 1:8, sep='');colnames(perc_AP_MCE)<- c("nhat_ms","Phat_ms", "nhat_tm", "Phat_tm")
  rownames(perc_CI_cov) <- paste(md, 1:8, sep=''); colnames(perc_CI_cov)<- c("%CIcov_ms", "%CIcov_tm")
  if(order.series.exp){
    rownames(Md) <-c('unif', 'unif+cos(1)','unif+cos(2)','unif+cos(3)', 'unif+cos(4)','unif+cos(5)',
                     "unif+s.poly(1)","unif+s.poly(2)","unif+s.poly(3)","unif+s.poly(4)","unif+s.poly(5)",
                     'hn', 'hn+cos(1)','hn+cos(2)','hn+cos(3)','hn+cos(4)',
                     "hn+H.poly(1)","hn+H.poly(2)","hn+H.poly(3)","hn+H.poly(4)",
                     'hr', "hr+cos(1)","hr+cos(2)","hr+cos(3)",
                     "hr+s.poly(1)","hr+s.poly(2)","hr+s.poly(3)" )
  } else{ rownames(Md) <- c('unif', 'unif+cos', "unif+s.poly",'hn', 'hn+cos', "hn+H.poly", 'hr', "hr+cos","hr+s.poly") }
  colnames (Md) <- paste(md, 1:8, sep='')
  
  # we rechange the directory to the original one
  setwd(default.wd)
  return(list (AP_mean= AP_mean, AP_median= AP_median, perc_AP_mean=perc_AP_mean, 
               perc_AP_median= perc_AP_median, AP_sd= AP_sd, AP_RMSE= AP_RMSE,  
               perc_AP_RMSE= perc_AP_RMSE, CI= perc_CI_cov, MCE= perc_AP_MCE, 
               Md= Md, Conv.prob= Conv.prob))
}




